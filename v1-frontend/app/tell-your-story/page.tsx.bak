'use client'\n\nimport { useState, useRef, useEffect } from 'react'\nimport Link from 'next/link'\n\ninterface RecordingState {\n  isRecording: boolean;\n  isPaused: boolean;\n  recordedBlob: Blob | null;\n  audioUrl: string | null;\n  duration: number;\n}\n\nexport default function TellYourStoryPage() {\n  const [recordingState, setRecordingState] = useState<RecordingState>({\n    isRecording: false,\n    isPaused: false,\n    recordedBlob: null,\n    audioUrl: null,\n    duration: 0\n  })\n  \n  const mediaRecorderRef = useRef<MediaRecorder | null>(null)\n  const chunksRef = useRef<Blob[]>([])\n  const timerRef = useRef<NodeJS.Timeout | null>(null)\n\n  const startRecording = async () => {\n    try {\n      const stream = await navigator.mediaDevices.getUserMedia({ audio: true })\n      mediaRecorderRef.current = new MediaRecorder(stream)\n      chunksRef.current = []\n\n      mediaRecorderRef.current.ondataavailable = (event) => {\n        if (event.data.size > 0) {\n          chunksRef.current.push(event.data)\n        }\n      }\n\n      mediaRecorderRef.current.onstop = () => {\n        const blob = new Blob(chunksRef.current, { type: 'audio/webm' })\n        const url = URL.createObjectURL(blob)\n        setRecordingState(prev => ({\n          ...prev,\n          recordedBlob: blob,\n          audioUrl: url,\n          isRecording: false\n        }))\n        \n        // Stop all tracks\n        stream.getTracks().forEach(track => track.stop())\n      }\n\n      mediaRecorderRef.current.start()\n      setRecordingState(prev => ({ ...prev, isRecording: true, duration: 0 }))\n      \n      // Start timer\n      timerRef.current = setInterval(() => {\n        setRecordingState(prev => ({ ...prev, duration: prev.duration + 1 }))\n      }, 1000)\n      \n    } catch (error) {\n      console.error('Error starting recording:', error)\n      alert('Unable to access microphone. Please check permissions.')\n    }\n  }\n\n  const stopRecording = () => {\n    if (mediaRecorderRef.current && recordingState.isRecording) {\n      mediaRecorderRef.current.stop()\n      if (timerRef.current) {\n        clearInterval(timerRef.current)\n      }\n    }\n  }\n\n  const uploadAudio = async () => {\n    if (!recordingState.recordedBlob) return\n    \n    const formData = new FormData()\n    formData.append('audio', recordingState.recordedBlob, 'recording.webm')\n    \n    try {\n      const response = await fetch('http://localhost:3001/api/upload/audio', {\n        method: 'POST',\n        body: formData\n      })\n      \n      if (response.ok) {\n        const result = await response.json()\n        alert(`Audio uploaded successfully! File: ${result.filename}`)\n      } else {\n        alert('Upload failed. Please try again.')\n      }\n    } catch (error) {\n      console.error('Upload error:', error)\n      alert('Upload failed. Make sure the backend server is running.')\n    }\n  }\n\n  const formatTime = (seconds: number) => {\n    const mins = Math.floor(seconds / 60)\n    const secs = seconds % 60\n    return `${mins}:${secs.toString().padStart(2, '0')}`\n  }\n\n  useEffect(() => {\n    return () => {\n      if (timerRef.current) {\n        clearInterval(timerRef.current)\n      }\n      if (recordingState.audioUrl) {\n        URL.revokeObjectURL(recordingState.audioUrl)\n      }\n    }\n  }, [])\n\n  return (\n    <div className=\"max-w-2xl mx-auto\">\n      <div className=\"card\">\n        <h1 className=\"text-3xl font-bold text-gray-900 mb-6\">\n          üé§ Tell Your Story\n        </h1>\n        <p className=\"text-gray-600 mb-8\">\n          Record your story to help create compelling content for your fundraising efforts. \n          Your audio can help you organize your thoughts and create a powerful written story.\n        </p>\n\n        {/* Recording Interface */}\n        <div className=\"text-center mb-8\">\n          {/* Recording Status */}\n          <div className=\"mb-6\">\n            {recordingState.isRecording ? (\n              <div>\n                <div className=\"animate-pulse\">\n                  <div className=\"w-20 h-20 bg-red-500 rounded-full mx-auto mb-4 flex items-center justify-center\">\n                    <div className=\"w-8 h-8 bg-white rounded-full\"></div>\n                  </div>\n                </div>\n                <p className=\"text-lg font-medium text-red-600\">Recording...</p>\n                <p className=\"text-2xl font-mono text-gray-700\">{formatTime(recordingState.duration)}</p>\n              </div>\n            ) : (\n              <div>\n                <div className=\"w-20 h-20 bg-gray-300 rounded-full mx-auto mb-4 flex items-center justify-center\">\n                  <svg className=\"w-8 h-8 text-gray-600\" fill=\"currentColor\" viewBox=\"0 0 24 24\">\n                    <path d=\"M12 14c1.66 0 3-1.34 3-3V5c0-1.66-1.34-3-3-3S9 3.34 9 5v6c0 1.66 1.34 3 3 3z\"/>\n                    <path d=\"M17 11c0 2.76-2.24 5-5 5s-5-2.24-5-5H5c0 3.53 2.61 6.43 6 6.92V21h2v-3.08c3.39-.49 6-3.39 6-6.92h-2z\"/>\n                  </svg>\n                </div>\n                <p className=\"text-lg font-medium text-gray-600\">Ready to record</p>\n              </div>\n            )}\n          </div>\n\n          {/* Controls */}\n          <div className=\"space-x-4 mb-6\">\n            {!recordingState.isRecording ? (\n              <button\n                onClick={startRecording}\n                className=\"btn-primary\"\n              >\n                üé§ Start Recording\n              </button>\n            ) : (\n              <button\n                onClick={stopRecording}\n                className=\"bg-red-600 hover:bg-red-700 text-white font-medium py-3 px-6 rounded-lg\"\n              >\n                ‚èπ Stop Recording\n              </button>\n            )}\n          </div>\n        </div>\n\n        {/* Playback */}\n        {recordingState.audioUrl && (\n          <div className=\"bg-green-50 rounded-lg p-6 mb-6\">\n            <h3 className=\"font-medium text-green-900 mb-3\">‚úÖ Recording Complete</h3>\n            <audio controls className=\"w-full mb-4\">\n              <source src={recordingState.audioUrl} type=\"audio/webm\" />\n              Your browser does not support the audio element.\n            </audio>\n            <div className=\"space-x-3\">\n              <button onClick={uploadAudio} className=\"btn-primary\">\n                üíæ Save Recording\n              </button>\n              <button \n                onClick={() => setRecordingState(prev => ({ ...prev, recordedBlob: null, audioUrl: null }))}\n                className=\"btn-secondary\"\n              >\n                üîÑ Record Again\n              </button>\n            </div>\n          </div>\n        )}\n\n        {/* Tips */}\n        <div className=\"bg-blue-50 rounded-lg p-4 mb-6\">\n          <h3 className=\"font-medium text-blue-900 mb-2\">üí° Recording Tips:</h3>\n          <ul className=\"text-sm text-blue-800 space-y-1\">\n            <li>‚Ä¢ Find a quiet space with minimal background noise</li>\n            <li>‚Ä¢ Speak clearly and at a normal pace</li>\n            <li>‚Ä¢ Tell your story chronologically - past, present, future needs</li>\n            <li>‚Ä¢ Include specific details about your situation</li>\n            <li>‚Ä¢ Express gratitude and hope</li>\n          </ul>\n        </div>\n\n        {/* Navigation */}\n        <div className=\"flex justify-between items-center pt-6 border-t\">\n          <Link href=\"/\" className=\"btn-secondary\">\n            ‚Üê Back to Home\n          </Link>\n          \n          <Link href=\"/gfm/5-story\" className=\"btn-primary\">\n            Continue to Story Writing ‚Üí\n          </Link>\n        </div>\n      </div>\n    </div>\n  )\n}