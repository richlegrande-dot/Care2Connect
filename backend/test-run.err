(node:34016) Warning: `--localstorage-file` was provided without a valid path
(Use `node --trace-warnings ...` to show where the warning was created)
FAIL tests/stripeWebhookSetup.test.ts
  â— Console

    console.log
      [startup] OpenAI key present: false

      at new StoryExtractionService (src/services/storyExtractionService.ts:26:13)

  â— Stripe webhook setup endpoints â€º GET /admin/setup/stripe-webhook returns booleans and no secrets

    expect(received).toBe(expected) // Object.is equality

    Expected: 200
    Received: 401

    [0m [90m  5 |[39m   it([32m'GET /admin/setup/stripe-webhook returns booleans and no secrets'[39m[33m,[39m [36masync[39m () [33m=>[39m {
     [90m  6 |[39m     [36mconst[39m res [33m=[39m [36mawait[39m request(app)[33m.[39m[36mget[39m([32m'/admin/setup/stripe-webhook'[39m)[33m;[39m
    [31m[1m>[22m[39m[90m  7 |[39m     expect(res[33m.[39mstatus)[33m.[39mtoBe([35m200[39m)[33m;[39m
     [90m    |[39m                        [31m[1m^[22m[39m
     [90m  8 |[39m     expect(res[33m.[39mbody[33m.[39mok)[33m.[39mtoBe([36mtrue[39m)[33m;[39m
     [90m  9 |[39m     expect(res[33m.[39mbody[33m.[39mconfigured)[33m.[39mtoHaveProperty([32m'stripeSecretKey'[39m)[33m;[39m
     [90m 10 |[39m     expect(res[33m.[39mbody[33m.[39mconfigured)[33m.[39mtoHaveProperty([32m'stripeWebhookSecret'[39m)[33m;[39m[0m

      at Object.<anonymous> (tests/stripeWebhookSetup.test.ts:7:24)

  â— Stripe webhook setup endpoints â€º POST /admin/setup/stripe-webhook/preflight respects ALLOW_SYSTEM_COMMANDS

    expect(received).toBe(expected) // Object.is equality

    Expected: 200
    Received: 401

    [0m [90m 17 |[39m     process[33m.[39menv[33m.[39m[33mALLOW_SYSTEM_COMMANDS[39m [33m=[39m [32m'false'[39m[33m;[39m
     [90m 18 |[39m     [36mconst[39m res [33m=[39m [36mawait[39m request(app)[33m.[39mpost([32m'/admin/setup/stripe-webhook/preflight'[39m)[33m;[39m
    [31m[1m>[22m[39m[90m 19 |[39m     expect(res[33m.[39mstatus)[33m.[39mtoBe([35m200[39m)[33m;[39m
     [90m    |[39m                        [31m[1m^[22m[39m
     [90m 20 |[39m     expect(res[33m.[39mbody[33m.[39mcliInstalled)[33m.[39mtoBe([32m'unknown'[39m)[33m;[39m
     [90m 21 |[39m   })[33m;[39m
     [90m 22 |[39m })[33m;[39m[0m

      at Object.<anonymous> (tests/stripeWebhookSetup.test.ts:19:24)

PASS tests/health.test.ts

Test Suites: 1 failed, 1 passed, 2 total
Tests:       2 failed, 14 passed, 16 total
Snapshots:   0 total
Time:        4.17 s, estimated 5 s
Ran all test suites matching /tests\\stripeWebhookSetup.test.ts|tests\\health.test.ts/i.
Jest did not exit one second after the test run has completed.

'This usually means that there are asynchronous operations that weren't stopped in your tests. Consider running Jest with `--detectOpenHandles` to troubleshoot this issue.

  â—  Cannot log after tests are done. Did you forget to wait for something async in your test?
    Attempted to log "ðŸ”„ Attempting database reconnection (1/5)...".

    [0m [90m 27 |[39m     metricsCollector[33m.[39mincrementDbReconnectAttempts()[33m;[39m
     [90m 28 |[39m     
    [31m[1m>[22m[39m[90m 29 |[39m     [36mconst[39m backoffTime [33m=[39m [36mthis[39m[33m.[39mreconnectBackoffMs [33m*[39m [33mMath[39m[33m.[39mpow([35m2[39m[33m,[39m [36mthis[39m[33m.[39mreconnectAttempts [33m-[39m [35m1[39m)[33m;[39m
     [90m    |[39m                 [31m[1m^[22m[39m
     [90m 30 |[39m
     [90m 31 |[39m     console[33m.[39mlog([32m`ðŸ”„ Attempting database reconnection (${this.reconnectAttempts}/${this.maxReconnectAttempts})...`[39m)[33m;[39m
     [90m 32 |[39m[0m

      at console.log (../node_modules/@jest/console/build/BufferedConsole.js:156:10)
      at SelfHealing.reconnectDatabase (src/monitoring/selfHealing.ts:29:17)
      at Timeout._onTimeout (src/monitoring/selfHealing.ts:58:28)


  â—  Cannot log after tests are done. Did you forget to wait for something async in your test?
    Attempted to log "â³ Retrying in 2000ms...".

    [0m [90m 39 |[39m       metricsCollector[33m.[39mresetDbReconnectAttempts()[33m;[39m
     [90m 40 |[39m       
    [31m[1m>[22m[39m[90m 41 |[39m       [36mreturn[39m [36mtrue[39m[33m;[39m
     [90m    |[39m                         [31m[1m^[22m[39m
     [90m 42 |[39m     } [36mcatch[39m (error) {
     [90m 43 |[39m       console[33m.[39merror([32m`âŒ Database reconnection failed: ${error}`[39m)[33m;[39m
     [90m 44 |[39m       [0m

      at console.log (../node_modules/@jest/console/build/BufferedConsole.js:156:10)
      at SelfHealing.reconnectDatabase (src/monitoring/selfHealing.ts:41:25)
      at Timeout._onTimeout (src/monitoring/selfHealing.ts:58:17)


  â—  Cannot log after tests are done. Did you forget to wait for something async in your test?
    Attempted to log "ðŸ”„ Attempting database reconnection (2/5)...".

    [0m [90m 27 |[39m     metricsCollector[33m.[39mincrementDbReconnectAttempts()[33m;[39m
     [90m 28 |[39m     
    [31m[1m>[22m[39m[90m 29 |[39m     [36mconst[39m backoffTime [33m=[39m [36mthis[39m[33m.[39mreconnectBackoffMs [33m*[39m [33mMath[39m[33m.[39mpow([35m2[39m[33m,[39m [36mthis[39m[33m.[39mreconnectAttempts [33m-[39m [35m1[39m)[33m;[39m
     [90m    |[39m                 [31m[1m^[22m[39m
     [90m 30 |[39m
     [90m 31 |[39m     console[33m.[39mlog([32m`ðŸ”„ Attempting database reconnection (${this.reconnectAttempts}/${this.maxReconnectAttempts})...`[39m)[33m;[39m
     [90m 32 |[39m[0m

      at console.log (../node_modules/@jest/console/build/BufferedConsole.js:156:10)
      at SelfHealing.reconnectDatabase (src/monitoring/selfHealing.ts:29:17)
      at SelfHealing.reconnectDatabase (src/monitoring/selfHealing.ts:43:29)
      at Timeout._onTimeout (src/monitoring/selfHealing.ts:58:17)


  â—  Cannot log after tests are done. Did you forget to wait for something async in your test?
    Attempted to log "â³ Retrying in 4000ms...".

    [0m [90m 39 |[39m       metricsCollector[33m.[39mresetDbReconnectAttempts()[33m;[39m
     [90m 40 |[39m       
    [31m[1m>[22m[39m[90m 41 |[39m       [36mreturn[39m [36mtrue[39m[33m;[39m
     [90m    |[39m                         [31m[1m^[22m[39m
     [90m 42 |[39m     } [36mcatch[39m (error) {
     [90m 43 |[39m       console[33m.[39merror([32m`âŒ Database reconnection failed: ${error}`[39m)[33m;[39m
     [90m 44 |[39m       [0m

      at console.log (../node_modules/@jest/console/build/BufferedConsole.js:156:10)
      at SelfHealing.reconnectDatabase (src/monitoring/selfHealing.ts:41:25)
      at Timeout._onTimeout (src/monitoring/selfHealing.ts:58:17)


  â—  Cannot log after tests are done. Did you forget to wait for something async in your test?
    Attempted to log "ðŸ”„ Attempting database reconnection (3/5)...".

    [0m [90m 27 |[39m     metricsCollector[33m.[39mincrementDbReconnectAttempts()[33m;[39m
     [90m 28 |[39m     
    [31m[1m>[22m[39m[90m 29 |[39m     [36mconst[39m backoffTime [33m=[39m [36mthis[39m[33m.[39mreconnectBackoffMs [33m*[39m [33mMath[39m[33m.[39mpow([35m2[39m[33m,[39m [36mthis[39m[33m.[39mreconnectAttempts [33m-[39m [35m1[39m)[33m;[39m
     [90m    |[39m                 [31m[1m^[22m[39m
     [90m 30 |[39m
     [90m 31 |[39m     console[33m.[39mlog([32m`ðŸ”„ Attempting database reconnection (${this.reconnectAttempts}/${this.maxReconnectAttempts})...`[39m)[33m;[39m
     [90m 32 |[39m[0m

      at console.log (../node_modules/@jest/console/build/BufferedConsole.js:156:10)
      at SelfHealing.reconnectDatabase (src/monitoring/selfHealing.ts:29:17)
      at SelfHealing.reconnectDatabase (src/monitoring/selfHealing.ts:43:29)
      at Timeout._onTimeout (src/monitoring/selfHealing.ts:58:17)


  â—  Cannot log after tests are done. Did you forget to wait for something async in your test?
    Attempted to log "â³ Retrying in 8000ms...".

    [0m [90m 39 |[39m       metricsCollector[33m.[39mresetDbReconnectAttempts()[33m;[39m
     [90m 40 |[39m       
    [31m[1m>[22m[39m[90m 41 |[39m       [36mreturn[39m [36mtrue[39m[33m;[39m
     [90m    |[39m                         [31m[1m^[22m[39m
     [90m 42 |[39m     } [36mcatch[39m (error) {
     [90m 43 |[39m       console[33m.[39merror([32m`âŒ Database reconnection failed: ${error}`[39m)[33m;[39m
     [90m 44 |[39m       [0m

      at console.log (../node_modules/@jest/console/build/BufferedConsole.js:156:10)
      at SelfHealing.reconnectDatabase (src/monitoring/selfHealing.ts:41:25)
      at Timeout._onTimeout (src/monitoring/selfHealing.ts:58:17)


  â—  Cannot log after tests are done. Did you forget to wait for something async in your test?
    Attempted to log "ðŸ”„ Attempting database reconnection (4/5)...".

    [0m [90m 27 |[39m     metricsCollector[33m.[39mincrementDbReconnectAttempts()[33m;[39m
     [90m 28 |[39m     
    [31m[1m>[22m[39m[90m 29 |[39m     [36mconst[39m backoffTime [33m=[39m [36mthis[39m[33m.[39mreconnectBackoffMs [33m*[39m [33mMath[39m[33m.[39mpow([35m2[39m[33m,[39m [36mthis[39m[33m.[39mreconnectAttempts [33m-[39m [35m1[39m)[33m;[39m
     [90m    |[39m                 [31m[1m^[22m[39m
     [90m 30 |[39m
     [90m 31 |[39m     console[33m.[39mlog([32m`ðŸ”„ Attempting database reconnection (${this.reconnectAttempts}/${this.maxReconnectAttempts})...`[39m)[33m;[39m
     [90m 32 |[39m[0m

      at console.log (../node_modules/@jest/console/build/BufferedConsole.js:156:10)
      at SelfHealing.reconnectDatabase (src/monitoring/selfHealing.ts:29:17)
      at SelfHealing.reconnectDatabase (src/monitoring/selfHealing.ts:43:29)
      at Timeout._onTimeout (src/monitoring/selfHealing.ts:58:17)


  â—  Cannot log after tests are done. Did you forget to wait for something async in your test?
    Attempted to log "â³ Retrying in 16000ms...".

    [0m [90m 39 |[39m       metricsCollector[33m.[39mresetDbReconnectAttempts()[33m;[39m
     [90m 40 |[39m       
    [31m[1m>[22m[39m[90m 41 |[39m       [36mreturn[39m [36mtrue[39m[33m;[39m
     [90m    |[39m                         [31m[1m^[22m[39m
     [90m 42 |[39m     } [36mcatch[39m (error) {
     [90m 43 |[39m       console[33m.[39merror([32m`âŒ Database reconnection failed: ${error}`[39m)[33m;[39m
     [90m 44 |[39m       [0m

      at console.log (../node_modules/@jest/console/build/BufferedConsole.js:156:10)
      at SelfHealing.reconnectDatabase (src/monitoring/selfHealing.ts:41:25)
      at Timeout._onTimeout (src/monitoring/selfHealing.ts:58:17)


  â—  Cannot log after tests are done. Did you forget to wait for something async in your test?
    Attempted to log "ðŸ”„ Attempting database reconnection (5/5)...".

    [0m [90m 27 |[39m     metricsCollector[33m.[39mincrementDbReconnectAttempts()[33m;[39m
     [90m 28 |[39m     
    [31m[1m>[22m[39m[90m 29 |[39m     [36mconst[39m backoffTime [33m=[39m [36mthis[39m[33m.[39mreconnectBackoffMs [33m*[39m [33mMath[39m[33m.[39mpow([35m2[39m[33m,[39m [36mthis[39m[33m.[39mreconnectAttempts [33m-[39m [35m1[39m)[33m;[39m
     [90m    |[39m                 [31m[1m^[22m[39m
     [90m 30 |[39m
     [90m 31 |[39m     console[33m.[39mlog([32m`ðŸ”„ Attempting database reconnection (${this.reconnectAttempts}/${this.maxReconnectAttempts})...`[39m)[33m;[39m
     [90m 32 |[39m[0m

      at console.log (../node_modules/@jest/console/build/BufferedConsole.js:156:10)
      at SelfHealing.reconnectDatabase (src/monitoring/selfHealing.ts:29:17)
      at SelfHealing.reconnectDatabase (src/monitoring/selfHealing.ts:43:29)
      at Timeout._onTimeout (src/monitoring/selfHealing.ts:58:17)


  â—  Cannot log after tests are done. Did you forget to wait for something async in your test?
    Attempted to log "âš ï¸  Alert (suppressed, ALERT_MODE=none): Database Reconnect Exceeded".

    [0m [90m 166 |[39m   [90m/**[39m
     [90m 167 |[39m [90m   * Get suggested fix based on health status[39m
    [31m[1m>[22m[39m[90m 168 |[39m [90m   */[39m
     [90m     |[39m                [31m[1m^[22m[39m
     [90m 169 |[39m   [36mprivate[39m getSuggestedFix(health[33m:[39m [33mHealthSnapshot[39m)[33m:[39m string {
     [90m 170 |[39m     [36mconst[39m fixes[33m:[39m string[] [33m=[39m [][33m;[39m
     [90m 171 |[39m     [36mif[39m ([33m![39m(health[33m?[39m[33m.[39mservices[33m?[39m[33m.[39mdb[33m?[39m[33m.[39mok [33m?[39m[33m?[39m [36mtrue[39m)) {[0m

      at console.log (../node_modules/@jest/console/build/BufferedConsole.js:156:10)
      at AlertManager.sendAlert (src/monitoring/alertManager.ts:168:21)
      at AlertManager.alertDbReconnectExceeded (src/monitoring/alertManager.ts:81:20)
      at SelfHealing.reconnectDatabase (src/monitoring/selfHealing.ts:23:47)
      at Timeout._onTimeout (src/monitoring/selfHealing.ts:58
  â—
  â—  Cannot log after tests are done. Did you forget to wait for something async in your test?
    Attempted to log "âš ï¸  Alert (suppressed, ALERT_MODE=none): Database Reconnect Exceeded".

    [0m [90m 166 |[39m   [90m/**[39m
     [90m 167 |[39m [90m   * Get suggested fix based on health status[39m
    [31m[1m>[22m[39m[90m 168 |[39m [90m   */[39m
     [90m     |[39m                [31m[1m^[22m[39m
     [90m 169 |[39m   [36mprivate[39m getSuggestedFix(health[33m:[39m [33mHealthSnapshot[39m)[33m:[39m string {
     [90m 170 |[39m     [36mconst[39m fixes[33m:[39m string[] [33m=[39m [][33m;[39m
     [90m 171 |[39m     [36mif[39m ([33m![39m(health[33m?[39m[33m.[39mservices[33m?[39m[33m.[39mdb[33m?[39m[33m.[39mok [33m?[39m[33m?[39m [36mtrue[39m)) {[0m

      at console.log (../node_modules/@jest/console/build/BufferedConsole.js:156:10)
      at AlertManager.sendAlert (src/monitoring/alertManager.ts:168:21)
      at AlertManager.alertDbReconnectExceeded (src/monitoring/alertManager.ts:81:20)
      at SelfHealing.reconnectDatabase (src/monitoring/selfHealing.ts:23:47)
      at Timeout._onTimeout (src/monitoring/selfHealing.ts:58
  â—
  â—  Cannot log after tests are done. Did you forget to wait for something async in your test?
    Attempted to log "âš ï¸  Alert (suppressed, ALERT_MODE=none): Database Reconnect Exceeded".

    [0m [90m 166 |[39m   [90m/**[39m
     [90m 167 |[39m [90m   * Get suggested fix based on health status[39m
    [31m[1m>[22m[39m[90m 168 |[39m [90m   */[39m
     [90m     |[39m                [31m[1m^[22m[39m
     [90m 169 |[39m   [36mprivate[39m getSuggestedFix(health[33m:[39m [33mHealthSnapshot[39m)[33m:[39m string {
     [90m 170 |[39m     [36mconst[39m fixes[33m:[39m string[] [33m=[39m [][33m;[39m
     [90m 171 |[39m     [36mif[39m ([33m![39m(health[33m?[39m[33m.[39mservices[33m?[39m[33m.[39mdb[33m?[39m[33m.[39mok [33m?[39m[33m?[39m [36mtrue[39m)) {[0m

      at console.log (../node_modules/@jest/console/build/BufferedConsole.js:156:10)
      at AlertManager.sendAlert (src/monitoring/alertManager.ts:168:21)
      at AlertManager.alertDbReconnectExceeded (src/monitoring/alertManager.ts:81:20)
      at SelfHealing.reconnectDatabase (src/monitoring/selfHealing.ts:23:47)
      at Timeout._onTimeout (src/monitoring/selfHealing.ts:58
  â—
  â—  Cannot log after tests are done. Did you forget to wait for something async in your test?
    Attempted to log "âš ï¸  Alert (suppressed, ALERT_MODE=none): Database Reconnect Exceeded".

    [0m [90m 166 |[39m   [90m/**[39m
     [90m 167 |[39m [90m   * Get suggested fix based on health status[39m
    [31m[1m>[22m[39m[90m 168 |[39m [90m   */[39m
     [90m     |[39m                [31m[1m^[22m[39m
     [90m 169 |[39m   [36mprivate[39m getSuggestedFix(health[33m:[39m [33mHealthSnapshot[39m)[33m:[39m string {
     [90m 170 |[39m     [36mconst[39m fixes[33m:[39m string[] [33m=[39m [][33m;[39m
     [90m 171 |[39m     [36mif[39m ([33m![39m(health[33m?[39m[33m.[39mservices[33m?[39m[33m.[39mdb[33m?[39m[33m.[39mok [33m?[39m[33m?[39m [36mtrue[39m)) {[0m

      at console.log (../node_modules/@jest/console/build/BufferedConsole.js:156:10)
      at AlertManager.sendAlert (src/monitoring/alertManager.ts:168:21)
      at AlertManager.alertDbReconnectExceeded (src/monitoring/alertManager.ts:81:20)
      at SelfHealing.reconnectDatabase (src/monitoring/selfHealing.ts:23:47)
      at Timeout._onTimeout (src/monitoring/selfHealing.ts:58
  â—
  â—  Cannot log after tests are done. Did you forget to wait for something async in your test?
    Attempted to log "âš ï¸  Alert (suppressed, ALERT_MODE=none): Database Reconnect Exceeded".

    [0m [90m 166 |[39m   [90m/**[39m
     [90m 167 |[39m [90m   * Get suggested fix based on health status[39m
    [31m[1m>[22m[39m[90m 168 |[39m [90m   */[39m
     [90m     |[39m                [31m[1m^[22m[39m
     [90m 169 |[39m   [36mprivate[39m getSuggestedFix(health[33m:[39m [33mHealthSnapshot[39m)[33m:[39m string {
     [90m 170 |[39m     [36mconst[39m fixes[33m:[39m string[] [33m=[39m [][33m;[39m
     [90m 171 |[39m     [36mif[39m ([33m![39m(health[33m?[39m[33m.[39mservices[33m?[39m[33m.[39mdb[33m?[39m[33m.[39mok [33m?[39m[33m?[39m [36mtrue[39m)) {[0m

      at console.log (../node_modules/@jest/console/build/BufferedConsole.js:156:10)
      at AlertManager.sendAlert (src/monitoring/alertManager.ts:168:21)
      at AlertManager.alertDbReconnectExceeded (src/monitoring/alertManager.ts:81:20)
      at SelfHealing.reconnectDatabase (src/monitoring/selfHealing.ts:23:47)
      at Timeout._onTimeout (src/monitoring/selfHealing.ts:58
  â—
  â—  Cannot log after tests are done. Did you forget to wait for something async in your test?
    Attempted to log "âš ï¸  Alert (suppressed, ALERT_MODE=none): Database Reconnect Exceeded".

    [0m [90m 166 |[39m   [90m/**[39m
     [90m 167 |[39m [90m   * Get suggested fix based on health status[39m
    [31m[1m>[22m[39m[90m 168 |[39m [90m   */[39m
     [90m     |[39m                [31m[1m^[22m[39m
     [90m 169 |[39m   [36mprivate[39m getSuggestedFix(health[33m:[39m [33mHealthSnapshot[39m)[33m:[39m string {
     [90m 170 |[39m     [36mconst[39m fixes[33m:[39m string[] [33m=[39m [][33m;[39m
     [90m 171 |[39m     [36mif[39m ([33m![39m(health[33m?[39m[33m.[39mservices[33m?[39m[33m.[39mdb[33m?[39m[33m.[39mok [33m?[39m[33m?[39m [36mtrue[39m)) {[0m

      at console.log (../node_modules/@jest/console/build/BufferedConsole.js:156:10)
      at AlertManager.sendAlert (src/monitoring/alertManager.ts:168:21)
      at AlertManager.alertDbReconnectExceeded (src/monitoring/alertManager.ts:81:20)
      at SelfHealing.reconnectDatabase (src/monitoring/selfHealing.ts:23:47)
      at Timeout._onTimeout (src/monitoring/selfHealing.ts:58
  â—
  â—  Cannot log after tests are done. Did you forget to wait for something async in your test?
    Attempted to log "âš ï¸  Alert (suppressed, ALERT_MODE=none): Database Reconnect Exceeded".

    [0m [90m 166 |[39m   [90m/**[39m
     [90m 167 |[39m [90m   * Get suggested fix based on health status[39m
    [31m[1m>[22m[39m[90m 168 |[39m [90m   */[39m
     [90m     |[39m                [31m[1m^[22m[39m
     [90m 169 |[39m   [36mprivate[39m getSuggestedFix(health[33m:[39m [33mHealthSnapshot[39m)[33m:[39m string {
     [90m 170 |[39m     [36mconst[39m fixes[33m:[39m string[] [33m=[39m [][33m;[39m
     [90m 171 |[39m     [36mif[39m ([33m![39m(health[33m?[39m[33m.[39mservices[33m?[39m[33m.[39mdb[33m?[39m[33m.[39mok [33m?[39m[33m?[39m [36mtrue[39m)) {[0m

      at console.log (../node_modules/@jest/console/build/BufferedConsole.js:156:10)
      at AlertManager.sendAlert (src/monitoring/alertManager.ts:168:21)
      at AlertManager.alertDbReconnectExceeded (src/monitoring/alertManager.ts:81:20)
      at SelfHealing.reconnectDatabase (src/monitoring/selfHealing.ts:23:47)
      at Timeout._onTimeout (src/monitoring/selfHealing.ts:58^C8)


