'use client'

import { useState, useEffect } from 'react'
import Link from 'next/link'
import { 
  CheckCircleIcon, 
  XCircleIcon, 
  ClockIcon,
  ArrowPathIcon,
  ServerIcon,
  CircleStackIcon,
  CreditCardIcon,
  CloudIcon,
  ChartBarIcon,
  ShieldCheckIcon,
  WrenchScrewdriverIcon,
  ExclamationTriangleIcon,
  BoltIcon
} from '@heroicons/react/24/outline'

interface ServiceStatus {
  ok: boolean
  message?: string
  latency?: number
  [key: string]: any
}

interface HealthData {
  status: 'healthy' | 'degraded' | 'unhealthy'
  timestamp: string
  uptime: number
  services: {
    db?: ServiceStatus
    storage?: ServiceStatus
    stripe?: ServiceStatus
    openai?: ServiceStatus
    [key: string]: ServiceStatus | undefined
  }
  metrics?: {
    totalRequests: number
    errorRate: number
    avgResponseTime: number
  }
}

export default function HealthPage() {
  const [health, setHealth] = useState<HealthData | null>(null)
  const [loading, setLoading] = useState(true)
  const [error, setError] = useState<string | null>(null)
  const [lastChecked, setLastChecked] = useState<Date>(new Date())
  const [connectivityTests, setConnectivityTests] = useState<{
    frontend: { ok: boolean; latency: number; error?: string } | null
    backend: { ok: boolean; latency: number; error?: string } | null
    database: { ok: boolean; latency: number; error?: string; detail?: string } | null
    proxy: { ok: boolean; latency: number; error?: string } | null
  }>({
    frontend: null,
    backend: null,
    database: null,
    proxy: null
  })
  const [healthHistory, setHealthHistory] = useState<any[]>([])
  const [isHealing, setIsHealing] = useState(false)
  const [healingLog, setHealingLog] = useState<string[]>([])
  const [autoRefreshEnabled, setAutoRefreshEnabled] = useState(true)

  const fetchHealth = async () => {
    try {
      setLoading(true)
      setError(null)
      const backendUrl = process.env.NEXT_PUBLIC_BACKEND_URL || 'http://localhost:3001'
      const response = await fetch(`${backendUrl}/health/ready`)
      
   

  const runConnectivityTests = async () => {
    const backendUrl = process.env.NEXT_PUBLIC_BACKEND_URL || 'http://localhost:3001'
    
    // Test Backend
    const backendStart = Date.now()
    try {
      const response = await fetch(`${backendUrl}/health/live`, { 
        method: 'GET',
        cache: 'no-store' 
      })
      const backendLatency = Date.now() - backendStart
      setConnectivityTests(prev => ({
        ...prev,
        backend: { ok: response.ok, latency: backendLatency }
      }))
    runConnectivityTests()
    fetchHealthHistory()
    
    // Auto-refresh every 30 seconds if enabled
    let healthInterval: NodeJS.Timeout | null = null
    let connectivityInterval: NodeJS.Timeout | null = null
    
    if (autoRefreshEnabled) {
      healthInterval = setInterval(() => {
        fetchHealth()
        fetchHealthHistory()
      }, 30000)
      
      connectivityInterval = setInterval(() => {
        runConnectivityTests()
      }, 15000) // Test connectivity more frequently
    }
    
    return () => {
      if (healthInterval) clearInterval(healthInterval)
      if (connectivityInterval) clearInterval(connectivityInterval)
    }
  }, [autoRefreshEnabled}))
    }

    // Test Frontend (self-test)
    const frontendStart = Date.now()
    try {
      const response = await fetch('/api/health', { method: 'HEAD', cache: 'no-store' })
      const frontendLatency = Date.now() - frontendStart
      setConnectivityTests(prev => ({
        ...prev,
        frontend: { ok: true, latency: frontendLatency }
      }))
    } catch (err) {
      setConnectivityTests(prev => ({
        ...prev,
        frontend: { ok: false, latency: Date.now() - frontendStart, error: err instanceof Error ? err.message : 'Failed' }
      }))
    }

    // Test Reverse Proxy (if accessible)
    const proxyStart = Date.now()
    try {
      const response = await fetch('http://localhost:8080', { 
        method: 'HEAD',
        cache: 'no-store',
        headers: { 'Host': 'care2connects.org' }
      })
      const proxyLatency = Date.now() - proxyStart
      setConnectivityTests(prev => ({
        ...prev,
        proxy: { ok: response.ok, latency: proxyLatency }
      }))
    } catch (err) {
      setConnectivityTests(prev => ({
        ...prev,
        proxy: { ok: false, latency: Date.now() - proxyStart, error: err instanceof Error ? err.message : 'Failed' }
      }))
    }
  }

  const fetchHealthHistory = async () => {
    try {
      const backendUrl = process.env.NEXT_PUBLIC_BACKEND_URL || 'http://localhost:3001'
      const response = await fetch(`${backendUrl}/health/history?limit=10`)
      if (response.ok) {
        const data = await response.json()
        setHealthHistory(data.history || [])
      }
    } catch (err) {
      console.error('Failed to fetch health history:', err)
    }
  }

  const triggerSelfHealing = async () => {
    setIsHealing(true)
    setHealingLog(['Starting self-healing process...'])
    
    try {
      const backendUrl = process.env.NEXT_PUBLIC_BACKEND_URL || 'http://localhost:3001'
      
      // Check services and attempt recovery
      setHealingLog(prev => [...prev, 'Checking database connection...'])
      
      // Test database
      try {div className="flex items-center gap-3">
              <button
                onClick={() => setAutoRefreshEnabled(!autoRefreshEnabled)}
                className={`flex items-center gap-2 px-4 py-2 rounded-lg font-semibold transition-colors ${
                  autoRefreshEnabled 
                    ? 'bg-green-100 text-green-700 hover:bg-green-200' 
                    : 'bg-gray-100 text-gray-700 hover:bg-gray-200'
                }`}
              >
                <BoltIcon className="w-5 h-5" />
                Auto-Refresh {autoRefreshEnabled ? 'ON' : 'OFF'}
              </button>
              <button
                onClick={fetchHealth}
                disabled={loading}
                className="flex items-center gap-2 px-4 py-2 bg-blue-600 hover:bg-blue-700 disabled:bg-gray-400 text-white rounded-lg font-semibold transition-colors"
              >
                <ArrowPathIcon className={`w-5 h-5 ${loading ? 'animate-spin' : ''}`} />
                Refresh
              </button>
              <button
                onClick={triggerSelfHealing}
                disabled={isHealing}
                className="flex items-center gap-2 px-4 py-2 bg-purple-600 hover:bg-purple-700 disabled:bg-gray-400 text-white rounded-lg font-semibold transition-colors"
              >
                <WrenchScrewdriverIcon className={`w-5 h-5 ${isHealing ? 'animate-spin' : ''}`} />
                Self-Heal
              </button>
            </divPromise(resolve => setTimeout(resolve, 3000))
          setHealingLog(prev => [...prev, 'Database reconnection triggered'])
        } else {
          setHealingLog(prev => [...prev, 'Database OK'])
        }
      } catch (err) {
        setHealingLog(prev => [...prev, `Database check failed: ${err instanceof Error ? err.message : 'Unknown error'}`])
      }

      // Check storage
      setHealingLog(prev => [...prev, 'Checking storage...'])
      await new Promise(resolve => setTimeout(resolve, 1000))
      setHealingLog(prev => [...prev, 'Storage check complete'])

      // Re-run connectivity tests
      setHealingLog(prev => [...prev, 'Running connectivity tests...'])
      await runConnectivityTests()
      setHealingLog(prev => [...prev, 'Connectivity tests complete'])

      // Refresh health status
      setHealingLog(prev => [...prev, 'Refreshing system status...'])
      await fetchHealth()
      setHealingLog(prev => [...prev, 'Self-healing complete!'])
      
    } catch (err) {
      setHealingLog(prev => [...prev, `Error: ${err instanceof Error ? err.message : 'Unknown error'}`])
    } finally {
      setIsHealing(false)
    }
  }   if (!response.ok) {
        throw new Error(`Health check failed: ${response.status}`)
      }
      
      const data = await response.json()
      setHealth(data)
      setLastChecked(new Date())
    } catch (err) {
      console.error('Health check error:', err)
      setError(err instanceof Error ? err.message : 'Failed to fetch health status')
    } finally {
      setLoading(false)
    }
  }

  useEffect(() => {
    fetchHealth()
    
    // Auto-refresh every 30 seconds
    const interval = setInterval(fetchHealth, 30000)
    return () => clearInterval(interval)
  }, [])

  const formatUptime = (seconds: number) => {
    const hours = Math.floor(seconds / 3600)
    const minutes = Math.floor((seconds % 3600) / 60)
    const secs = Math.floor(seconds % 60)
    
    if (hours > 0) return `${hours}h ${minutes}m`
    if (minutes > 0) return `${minutes}m ${secs}s`
    return `${secs}s`
  }

  const getStatusColor = (status?: 'healthy' | 'degraded' | 'unhealthy') => {
    switch (status) {
      case 'healthy': return 'text-green-600'
      case 'degraded': return 'text-yellow-600'
      case 'unhealthy': return 'text-red-600'
      default: return 'text-gray-400'
    }
  }

  const getStatusBg = (status?: 'healthy' | 'degraded' | 'unhealthy') => {
    switch (status) {
      case 'healthy': return 'bg-green-50 border-green-200'
      case 'degraded': return 'bg-yellow-50 border-yellow-200'
      case 'unhealthy': return 'bg-red-50 border-red-200'
      default: return 'bg-gray-50 border-gray-200'
    }
  }

  const ServiceCard = ({ 
    name, 
    icon: Icon, 
    status 
  }: { 
    name: string
    icon: React.ComponentType<{ className?: string }>
    status?: ServiceStatus 
  }) => (
    <div className={`p-6 rounded-lg border-2 ${status?.ok ? 'bg-green-50 border-green-200' : 'bg-red-50 border-red-200'}`}>
      <div className="flex items-start justify-between">
        <div className="flex items-center gap-3">
          <Icon className="w-8 h-8 text-gray-700" />
          <div>
            <h3 className="font-bold text-lg text-gray-900">{name}</h3>
            {status?.message && (
              <p className="text-sm text-gray-600 mt-1">{status.message}</p>
            )}
          </div>
        </div>
        <div className="flex flex-col items-end gap-1">
          {status?.ok ? (
            <CheckCircleIcon className="w-8 h-8 text-green-600" />
          ) : (
            <XCircleIcon className="w-8 h-8 text-red-600" />
          )}
          {status?.latency && (
            <span className="text-xs text-gray-500">{status.latency}ms</span>
          )}
        </div>
      </div>
    </div>
  )

  return (
    <div className="min-h-screen bg-gradient-to-br from-slate-50 via-blue-50 to-slate-50">
      {/* Header */}
      <div className="bg-white border-b-2 border-blue-100 shadow-sm">
        <div className="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-6">
          <div className="flex items-center justify-between">
            <div className="flex items-center gap-4">
              <Link 
                href="/" 
                className="text-blue-600 hover:text-blue-800 transition-colors"
              >
                <ShieldCheckIcon className="w-8 h-8" />
              </Link>
              <div>
                <h1 className="text-3xl font-black text-gray-900">System Health</h1>
                <p className="text-gray-600">Real-time system status and monitoring</p>
              </div>
            </div>
            <button
              onClick={fetchHealth}
              disabled={loading}
              className="flex items-center gap-2 px-4 py-2 bg-blue-600 hover:bg-blue-700 disabled:bg-gray-400 text-white rounded-lg font-semibold transition-colors"
            >
              <ArrowPathIcon className={`w-5 h-5 ${loading ? 'animate-spin' : ''}`} />
              Refresh
            </button>
          </div>
        </div>
      </div>

      <div className="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-12">
        {/* Overall Status Banner */}
        {health && (
          <div className={`p-6 rounded-xl border-2 mb-8 ${getStatusBg(health.status)}`}>
            <div className="flex items-center justify-between">
              <div className="flex items-center gap-4">
                {health.status === 'healthy' ? (
                  <CheckCircleIcon className="w-12 h-12 text-green-600" />
                ) : health.status === 'degraded' ? (
                  <ClockIcon className="w-12 h-12 text-yellow-600" />
                ) : (
                  <XCircleIcon className="w-12 h-12 text-red-600" />
                )}
                <div>
                  <h2 className={`text-2xl font-bold ${getStatusColor(health.status)}`}>
                    {health.status === 'healthy' && 'All Systems Operational'}
                    {health.status === 'degraded' && 'Partial Service Degradation'}
                    {health.status === 'unhealthy' && 'Service Outage'}
                  </h2>
                  <p className="text-gray-600 mt-1">
                    Uptime: {formatUptime(health.uptime)} • Last checked: {lastChecked.toLocaleTimeString()}
                  </p>
                </div>
              </div>
              {health.metrics && (
                <div className="text-right">
                  <div className="text-sm text-gray-600">Requests</div>
                  <div className="text-2xl font-bold text-gray-900">{health.metrics.totalRequests.toLocaleString()}</div>
                </div>
              )}
            </div>
          </div>
        )}

        {/* Error State */}
        {error && (
          <div className="bg-red-50 border-2 border-red-200 rounded-lg p-6 mb-8">
            <div className="flex items-center gap-3">
              <XCircleIcon className="w-8 h-8 text-red-600" />
              <div>
                <h3 className="font-bold text-red-900">Unable to fetch system health</h3>
                <p className="text-red-700 mt-1">{error}</p>
              </div>
            </div>
          </div>
        )}

        {/* Loading State */}
        {loading && !health && (
          <div className="flex items-center justify-center py-20">
            <ArrowPathIcon className="w-12 h-12 text-blue-600 animate-spin" />
          </div>
        )}

        {/* Service Status Grid */}
        {health && (
          <>
            <h2 className="text-2xl font-bold text-gray-900 mb-6">Service Status</h2>
            <div className="grid md:grid-cols-2 gap-6 mb-12">
              <ServiceCard
                name="Database"
                icon={CircleStackIcon}
                status={health.services.db}
              />
              <ServiceCard
                name="File Storage"
                icon={CloudIcon}
                status={health.services.storage}
              />
              <ServiceCard
                name="Payment Processing"
                icon={CreditCardIcon}
                status={health.services.stripe}
              />
            Connectivity Tests */}
        <div className="mt-8 bg-white p-6 rounded-lg border-2 border-purple-200">
          <div className="flex items-center justify-between mb-4">
            <div className="flex items-center gap-2">
              <WrenchScrewdriverIcon className="w-6 h-6 text-purple-600" />
              <h3 className="font-bold text-lg text-gray-900">Connectivity Tests</h3>
            </div>
            <button
              onClick={runConnectivityTests}
              className="text-sm px-3 py-1 bg-purple-100 text-purple-700 rounded hover:bg-purple-200 transition-colors"
            >
              Run Tests
            </button>
          </div>
          <div className="grid md:grid-cols-3 gap-4">
            <div className={`p-4 rounded-lg border-2 ${connectivityTests.backend?.ok ? 'bg-green-50 border-green-200' : 'bg-red-50 border-red-200'}`}>
              <div className="font-semibold text-gray-900 mb-2">Backend API</div>
              {connectivityTests.backend ? (
                <>
                  <div className={`text-sm ${connectivityTests.backend.ok ? 'text-green-700' : 'text-red-700'}`}>
                    {connectivityTests.backend.ok ? 'Connected' : 'Failed'}
                  </div>
                  <div className="text-xs text-gray-600 mt-1">
                    {connectivityTests.backend.latency}ms latency
                  </div>
                  {connectivityTests.backend.error && (
                    <div className="text-xs text-red-600 mt-1">{connectivityTests.backend.error}</div>
                  )}
                </>
              ) : (
                <div className="text-sm text-gray-500">Testing...</div>
              )}
            </div>
            
            <div className={`p-4 rounded-lg border-2 ${connectivityTests.frontend?.ok ? 'bg-green-50 border-green-200' : 'bg-red-50 border-red-200'}`}>
              <div className="font-semibold text-gray-900 mb-2">Frontend App</div>
              {connectivityTests.frontend ? (
                <>
                  <div className={`text-sm ${connectivityTests.frontend.ok ? 'text-green-700' : 'text-red-700'}`}>
                    {connectivityTests.frontend.ok ? 'Running' : 'Failed'}
                  </div>
                  <div className="text-xs text-gray-600 mt-1">
                    {connectivityTests.frontend.latency}ms response
                  </div>
                </>
              ) : (
                <div className="text-sm text-gray-500">Testing...</div>
              )}
            </div>

            <div className={`p-4 rounded-lg border-2 ${connectivityTests.proxy?.ok ? 'bg-green-50 border-green-200' : 'bg-yellow-50 border-yellow-200'}`}>
              <div className="font-semibold text-gray-900 mb-2">Reverse Proxy</div>
              {connectivityTests.proxy ? (
                <>
                  <div className={`text-sm ${connectivityTests.proxy.ok ? 'text-green-700' : 'text-yellow-700'}`}>
                    {connectivityTests.proxy.ok ? 'Active' : 'Unreachable'}
                  </div>
                  <div className="text-xs text-gray-600 mt-1">
                    {connectivityTests.proxy.latency}ms latency
                  </div>
                </>
              ) : (
                <div className="text-sm text-gray-500">Testing...</div>
              )}
            </div>
          </div>
        </div>

        {/* Self-Healing Log */}
        {healingLog.length > 0 && (
          <div className="mt-8 bg-purple-50 border-2 border-purple-200 rounded-lg p-6">
            <div className="flex items-center gap-2 mb-4">
              <WrenchScrewdriverIcon className="w-6 h-6 text-purple-600" />
              <h3 className="font-bold text-lg text-gray-900">Self-Healing Log</h3>
            </div>
            <div className="bg-white rounded border border-purple-200 p-4 max-h-60 overflow-y-auto">
              {healingLog.map((log, idx) => (
                <div key={idx} className="text-sm text-gray-700 font-mono py-1">
                  {log}
                </div>
              ))}
            </div>
          </div>
        )}

        {/* Health History */}
        {healthHistory.length > 0 && (
          <div className="mt-8 bg-white p-6 rounded-lg border-2 border-gray-200">
            <h3 className="font-bold text-lg text-gray-900 mb-4">Recent Health Checks</h3>
            <div className="overflow-x-auto">
              <table className="w-full text-sm">
                <thead>
                  <tr className="border-b">
                    <th className="text-left py-2">Time</th>
                    <th className="text-left py-2">Status</th>
                    <th className="text-left py-2">DB</th>
                    <th className="text-left py-2">Storage</th>
                    <th className="text-left py-2">Stripe</th>
                  </tr>
                </thead>
                <tbody>
                  {healthHistory.slice(0, 5).map((record, idx) => (
                    <tr key={idx} className="border-b">
                      <td className="py-2 text-gray-600">
                        {new Date(record.timestamp).toLocaleTimeString()}
                      </td>
                      <td className="py-2">
                        <span className={`inline-block px-2 py-1 rounded text-xs font-semibold ${
                          record.status === 'healthy' ? 'bg-green-100 text-green-800' :
                          record.status === 'degraded' ? 'bg-yellow-100 text-yellow-800' :
                          'bg-red-100 text-red-800'
                        }`}>
                          {record.status}
                        </span>
                      </td>
                      <td className="py-2">
                        {record.services?.db?.ok ? 
                          <CheckCircleIcon className="w-5 h-5 text-green-600" /> : 
                          <XCircleIcon className="w-5 h-5 text-red-600" />
                        }
                      </td>
                      <td className="py-2">
                        {record.services?.storage?.ok ? 
                          <CheckCircleIcon className="w-5 h-5 text-green-600" /> : 
                          <XCircleIcon className="w-5 h-5 text-red-600" />
                        }
                      </td>
                      <td className="py-2">
                        {record.services?.stripe?.ok ? 
                          <CheckCircleIcon className="w-5 h-5 text-green-600" /> : 
                          <XCircleIcon className="w-5 h-5 text-red-600" />
                        }
                      </td>
                    </tr>
                  ))}
                </tbody>
              </table>
            </div>
          </div>
        )}

        {/* Quick Links */}
        <div className="mt-8scription"
                icon={ServerIcon}
                status={health.services.openai}
              />
            </div>

            {/* Performance Metrics */}
            {health.metrics && (
              <>
                <h2 className="text-2xl font-bold text-gray-900 mb-6">Performance Metrics</h2>
                <div className="grid md:grid-cols-3 gap-6">
                  <div className="bg-white p-6 rounded-lg border-2 border-gray-200">
                    <ChartBarIcon className="w-8 h-8 text-blue-600 mb-3" />
                    <div className="text-3xl font-bold text-gray-900 mb-1">
                      {health.metrics.totalRequests.toLocaleString()}
                    </div>
                    <div className="text-sm text-gray-600">Total Requests</div>
                  </div>
                  <div className="bg-white p-6 rounded-lg border-2 border-gray-200">
                    <ChartBarIcon className="w-8 h-8 text-green-600 mb-3" />
                    <div className="text-3xl font-bold text-gray-900 mb-1">
                      {health.metrics.avgResponseTime}ms
                    </div>
                    <div className="text-sm text-gray-600">Avg Response Time</div>
                  </div>
                  <div className="bg-white p-6 rounded-lg border-2 border-gray-200">
                    <ChartBarIcon className={`w-8 h-8 mb-3 ${health.metrics.errorRate > 5 ? 'text-red-600' : 'text-yellow-600'}`} />
                    <div className="text-3xl font-bold text-gray-900 mb-1">
                      {health.metrics.errorRate.toFixed(1)}%
                    </div>
                    <div className="text-sm text-gray-600">Error Rate</div>
                  </div>
                </div>
              </>
            )}
          </>
        )}

        {/* Quick Links */}
        <div className="mt-12 bg-white p-6 rounded-lg border-2 border-blue-200">
          <h3 className="font-bold text-lg text-gray-900 mb-4">Quick Links</h3>
          <div className="grid md:grid-cols-2 gap-4">
            <Link 
              href="/tell-story"
              className="flex items-center gap-2 text-blue-600 hover:text-blue-800 font-semibold"
            >
              <span>→</span> Tell Your Story (Recording)
            </Link>
            <Link 
              href="/donate"
              className="flex items-center gap-2 text-blue-600 hover:text-blue-800 font-semibold"
            >
              <span>→</span> Donation System
            </Link>
            <Link 
              href="/"
              className="flex items-center gap-2 text-blue-600 hover:text-blue-800 font-semibold"
            >
              <span>→</span> Home
            </Link>
            <a 
              href={`${process.env.NEXT_PUBLIC_BACKEND_URL || 'http://localhost:3001'}/health/live`}
              target="_blank"
              rel="noopener noreferrer"
              className="flex items-center gap-2 text-blue-600 hover:text-blue-800 font-semibold"
            >
              <span>→</span> API Health (JSON)
            </a>
          </div>
        </div>
      </div>
    </div>
  )
}
