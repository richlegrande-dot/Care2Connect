# DNS and Domain Configuration Guide

## Domain Setup

### Primary Domain Configuration
```
Primary Domain: careconnect.org
API Subdomain: api.careconnect.org
Admin Subdomain: admin.careconnect.org
Storage Subdomain: storage.careconnect.org (if using custom CDN)
```

### DNS Records Configuration

#### A Records
```
Type: A
Name: @
Value: [Vercel IP Address - automatically managed]
TTL: 300

Type: A  
Name: www
Value: [Vercel IP Address - automatically managed]
TTL: 300
```

#### CNAME Records
```
Type: CNAME
Name: api
Value: careconnect-api.onrender.com (or your Render app URL)
TTL: 300

Type: CNAME
Name: admin
Value: careconnect.vercel.app
TTL: 300

Type: CNAME
Name: storage
Value: [Supabase storage URL or S3 CloudFront distribution]
TTL: 300
```

#### MX Records (for email)
```
Type: MX
Name: @
Value: 10 mx1.forwardemail.net
TTL: 300

Type: MX
Name: @
Value: 20 mx2.forwardemail.net
TTL: 300
```

#### TXT Records
```
# Domain verification for Vercel
Type: TXT
Name: @
Value: [Vercel verification token]
TTL: 300

# SPF record for email
Type: TXT
Name: @
Value: v=spf1 include:spf.forwardemail.net ~all
TTL: 300

# DMARC policy
Type: TXT
Name: _dmarc
Value: v=DMARC1; p=quarantine; rua=mailto:admin@careconnect.org
TTL: 300

# DKIM key (generated by email provider)
Type: TXT
Name: default._domainkey
Value: [DKIM key from email provider]
TTL: 300
```

## Vercel Domain Configuration

### vercel.json Domain Settings
```json
{
  "domains": [
    "careconnect.org",
    "www.careconnect.org",
    "admin.careconnect.org"
  ],
  "redirects": [
    {
      "source": "/(.*)",
      "has": [
        {
          "type": "host",
          "value": "www.careconnect.org"
        }
      ],
      "destination": "https://careconnect.org/$1",
      "permanent": true
    }
  ]
}
```

### Environment Variables for Domains
```bash
# Frontend (.env.production)
NEXT_PUBLIC_API_URL=https://api.careconnect.org
NEXT_PUBLIC_APP_URL=https://careconnect.org
NEXT_PUBLIC_STORAGE_URL=https://storage.careconnect.org

# Backend (.env.production)
CORS_ORIGIN=https://careconnect.org,https://admin.careconnect.org
FRONTEND_URL=https://careconnect.org
API_BASE_URL=https://api.careconnect.org
```

## SSL/TLS Configuration

### Automatic SSL (Recommended)
```yaml
# Vercel handles SSL automatically
# Render handles SSL automatically  
# Supabase handles SSL automatically

# Custom SSL configuration (if needed)
ssl:
  certificate_path: /etc/ssl/certs/careconnect.org.crt
  private_key_path: /etc/ssl/private/careconnect.org.key
  ca_bundle_path: /etc/ssl/certs/ca-bundle.crt
```

### SSL Security Headers
```typescript
// Already configured in helmet.ts and vercel.json
const sslHeaders = {
  'Strict-Transport-Security': 'max-age=31536000; includeSubDomains; preload',
  'Content-Security-Policy': "upgrade-insecure-requests",
  'X-Content-Type-Options': 'nosniff',
  'X-Frame-Options': 'DENY',
  'X-XSS-Protection': '1; mode=block'
};
```

## CDN Configuration

### Vercel Edge Network
```json
{
  "regions": ["all"],
  "functions": {
    "pages/api/**/*.js": {
      "runtime": "nodejs18.x",
      "regions": ["iad1", "sfo1", "fra1"]
    }
  }
}
```

### CloudFlare Configuration (Optional)
```yaml
# cloudflare-config.yml
zones:
  - name: careconnect.org
    settings:
      ssl: "strict"
      min_tls_version: "1.2"
      always_use_https: true
      automatic_https_rewrites: true
      cache_level: "aggressive"
      browser_cache_ttl: 14400
      edge_cache_ttl: 86400
      
    page_rules:
      - targets: "api.careconnect.org/*"
        actions:
          cache_level: "bypass"
          disable_performance: true
          
      - targets: "*.careconnect.org/static/*"
        actions:
          cache_level: "cache_everything"
          edge_cache_ttl: 2592000
          browser_cache_ttl: 2592000
```

## Load Balancing and Failover

### DNS-based Load Balancing
```
# Primary API server
Type: A
Name: api
Value: [Primary Render server IP]
TTL: 60

# Backup API server (Fly.io)
Type: A  
Name: api-backup
Value: [Fly.io server IP]
TTL: 60

# Weighted routing (if supported by DNS provider)
Type: A
Name: api
Value: [Primary server IP]
Weight: 100
TTL: 60

Type: A
Name: api
Value: [Backup server IP] 
Weight: 0
TTL: 60
```

### Health Check Based Routing
```yaml
# health-check-routing.yml
endpoints:
  primary:
    url: https://careconnect-api.onrender.com/health
    weight: 100
    
  backup:
    url: https://careconnect-api.fly.dev/health
    weight: 0
    
routing_rules:
  - if: primary.health_check_fails
    then: route_to_backup
    
  - if: primary.response_time > 5000ms
    then: distribute_traffic_50_50
```

## Monitoring and Alerts

### Domain Monitoring
```bash
#!/bin/bash
# scripts/domain-monitor.sh

DOMAINS=(
    "careconnect.org"
    "api.careconnect.org"
    "admin.careconnect.org"
)

for domain in "${DOMAINS[@]}"; do
    # Check DNS resolution
    if ! nslookup "$domain" > /dev/null 2>&1; then
        echo "❌ DNS resolution failed for $domain"
        send_alert "DNS failure" "$domain cannot be resolved"
    fi
    
    # Check SSL certificate
    expiry_date=$(echo | openssl s_client -servername "$domain" -connect "$domain:443" 2>/dev/null | openssl x509 -noout -dates | grep notAfter | cut -d= -f2)
    expiry_seconds=$(date -d "$expiry_date" +%s)
    current_seconds=$(date +%s)
    days_until_expiry=$(( (expiry_seconds - current_seconds) / 86400 ))
    
    if [ "$days_until_expiry" -lt 30 ]; then
        echo "⚠️  SSL certificate for $domain expires in $days_until_expiry days"
        send_alert "SSL expiring soon" "$domain certificate expires in $days_until_expiry days"
    fi
    
    # Check HTTPS availability
    if ! curl -s -I "https://$domain" | grep -q "200 OK"; then
        echo "❌ HTTPS check failed for $domain"
        send_alert "HTTPS failure" "$domain is not responding over HTTPS"
    fi
done
```

### DNS Propagation Check
```javascript
// scripts/check-dns-propagation.js
const dns = require('dns').promises;

const checkDNSPropagation = async (domain, recordType = 'A') => {
  const servers = [
    '8.8.8.8',      // Google
    '1.1.1.1',      // Cloudflare
    '208.67.222.222', // OpenDNS
    '9.9.9.9'       // Quad9
  ];
  
  const results = {};
  
  for (const server of servers) {
    try {
      const resolver = new dns.Resolver();
      resolver.setServers([server]);
      
      let records;
      switch (recordType) {
        case 'A':
          records = await resolver.resolve4(domain);
          break;
        case 'CNAME':
          records = await resolver.resolveCname(domain);
          break;
        case 'MX':
          records = await resolver.resolveMx(domain);
          break;
        default:
          records = await resolver.resolve4(domain);
      }
      
      results[server] = records;
    } catch (error) {
      results[server] = { error: error.message };
    }
  }
  
  return results;
};

// Usage
(async () => {
  const domain = process.argv[2] || 'careconnect.org';
  console.log(`Checking DNS propagation for ${domain}...`);
  
  const results = await checkDNSPropagation(domain);
  console.log(JSON.stringify(results, null, 2));
})();
```

## Environment-Specific Configuration

### Development
```bash
# .env.local
NEXT_PUBLIC_API_URL=http://localhost:3001
NEXT_PUBLIC_APP_URL=http://localhost:3000
```

### Staging
```bash
# .env.staging
NEXT_PUBLIC_API_URL=https://api-staging.careconnect.org
NEXT_PUBLIC_APP_URL=https://staging.careconnect.org
```

### Production
```bash
# .env.production
NEXT_PUBLIC_API_URL=https://api.careconnect.org
NEXT_PUBLIC_APP_URL=https://careconnect.org
```

## Deployment Commands

### Domain Setup Commands
```bash
# Add domain to Vercel
vercel domains add careconnect.org

# Verify domain
vercel domains verify careconnect.org

# Add custom domain to Render
curl -X POST "https://api.render.com/v1/services/${SERVICE_ID}/custom-domains" \
  -H "Authorization: Bearer ${RENDER_API_KEY}" \
  -H "Content-Type: application/json" \
  -d '{"name": "api.careconnect.org"}'

# Update DNS records (example with CloudFlare API)
curl -X POST "https://api.cloudflare.com/client/v4/zones/${ZONE_ID}/dns_records" \
  -H "X-Auth-Email: ${CF_EMAIL}" \
  -H "X-Auth-Key: ${CF_API_KEY}" \
  -H "Content-Type: application/json" \
  -d '{
    "type": "CNAME",
    "name": "api",
    "content": "careconnect-api.onrender.com",
    "ttl": 300
  }'
```

This DNS and domain configuration ensures:
- Proper domain routing to correct services
- SSL/TLS security across all subdomains  
- Load balancing and failover capabilities
- Comprehensive monitoring and alerting
- Environment-specific configurations
- Automated deployment and verification